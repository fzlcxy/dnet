# 协议配置GUI工具 - 开发文档

## 项目概述

协议配置GUI工具用于配置C2S（客户端到服务端）协议与S2C（服务端到客户端）回包之间的映射关系。

## 目录结构

```
dnet/
├── clientscript/           # 源代码目录
│   ├── main.py            # 程序入口
│   ├── gui_main_window.py # GUI主窗口实现
│   ├── config_manager.py  # 配置管理模块
│   ├── dnet_parser.py     # .dnet协议文件解析器
│   └── gui_settings.json  # GUI设置文件（运行时生成）
├── proto/                  # 协议文件目录（.dnet文件）
├── clientconfig/           # 配置输出目录
├── docs/                   # 文档目录
├── openspec/               # OpenSpec规范目录
├── build.bat              # 打包脚本
├── protocol_config_gui.spec # PyInstaller打包配置
└── requirements.txt        # 依赖列表
```

## 模块说明

### main.py
程序入口，负责启动GUI主窗口。

### gui_main_window.py
GUI主窗口实现，包含：
- `MainWindow` - 主窗口类
- `ResponseEditDialog` - S2C响应编辑对话框
- `NewGroupDialog` - 新建顺序组对话框
- `OrderGroupEditDialog` - 编辑顺序组说明对话框
- `SettingsDialog` - 设置目录对话框
- `ToolTip` - 悬停提示组件
- `get_base_path()` - 获取基础路径（兼容打包后运行）

### config_manager.py
配置管理模块，包含：
- `S2CResponse` - S2C响应数据类
- `OrderGroup` - 顺序组数据类
- `C2SMapping` - C2S映射配置
- `C2SConfig` - 配置文件数据类
- `ConfigManager` - 配置管理器（加载/保存/验证）

### dnet_parser.py
.dnet协议文件解析器，包含：
- `Field` - 字段数据类
- `Protocol` - 协议数据类
- `DnetFile` - 解析后的dnet文件
- `DnetParser` - 解析器类

## 数据结构

### S2CResponse
```python
@dataclass
class S2CResponse:
    protocol: str      # 协议名称
    order: int         # 顺序号（有序项从1开始，无序项为0）
    type: str          # "必然回包" 或 "按条件回包"
    condition: str     # 条件说明/备注
    count: str         # "一次" 或 "多次"
    order_group: str   # 顺序组名称（空表示无组）
    ordered: bool      # True=顺序(数字序号)，False=无序(x标记)
```

### 配置文件格式 (JSON)
```json
{
  "dnet_file": "nethero.dnet",
  "description": "英雄相关协议",
  "c2s_mappings": {
    "C2SUpdateHeroName": {
      "description": "更新英雄名称",
      "order_groups": [
        {"name": "A", "description": "顺序不确定"}
      ],
      "responses": [
        {
          "protocol": "S2CUpdateHero",
          "order": 1,
          "type": "必然回包",
          "condition": "",
          "count": "一次",
          "order_group": "A",
          "ordered": true
        }
      ]
    }
  }
}
```

## 开发环境

### 依赖
- Python 3.8+
- tkinter（Python标准库）
- PyInstaller（打包时需要）

### 运行
```bash
cd clientscript
python main.py
```

### 调试
程序使用tkinter构建GUI，可以直接运行main.py进行调试。

## 打包发布

### 方式一：使用打包脚本
```bash
# Windows
build.bat
```

### 方式二：手动打包
```bash
# 安装PyInstaller
pip install pyinstaller

# 打包
pyinstaller protocol_config_gui.spec --noconfirm
```

### 打包输出
```
dist/
└── 协议配置工具/
    ├── 协议配置工具.exe
    └── _internal/
```

### 路径兼容
打包后程序使用 `get_base_path()` 函数处理路径：
```python
def get_base_path():
    if getattr(sys, 'frozen', False):
        # 打包后：exe所在目录
        return os.path.dirname(sys.executable)
    else:
        # 开发环境：脚本所在目录
        return os.path.dirname(os.path.abspath(__file__))
```

## GUI功能说明

### 界面布局
- **左侧面板**：选择C2S协议文件、选择S2C协议、C2S详情
- **右侧面板**：C2S协议列表、S2C回包配置、S2C详情
- **状态栏**：状态信息、修改状态、统计信息

### 配置标记
- 绿色圆点(●)：表示已配置
- 文件树和C2S列表中已配置项显示绿色

### 顺序状态
- **顺序**：使用数字序号（1, 2, 3...）
- **无序**：使用x标记，不参与排序

### 顺序组
- 相同顺序组的响应表示返回顺序不确定
- 显示格式：`1[A]`、`x[A]`
- 相同组使用相同背景色

### 快捷键
| 快捷键 | 功能 |
|--------|------|
| Ctrl+S | 保存配置 |
| Ctrl+Z | 撤销 |
| Ctrl+Y | 重做 |
| F5 | 刷新文件列表 |
| Delete | 删除选中项 |

## 扩展开发

### 添加新的响应类型
1. 修改 `S2CResponse` 数据类
2. 修改 `ResponseEditDialog` 对话框
3. 修改 `_edit_condition()` 方法
4. 修改 `_load_c2s_config()` 显示逻辑

### 添加新的配置字段
1. 修改 `config_manager.py` 中的数据类
2. 修改 `_dict_to_config()` 和 `_config_to_dict()` 方法
3. 更新GUI编辑对话框

## 注意事项

1. **编码**：所有文件使用UTF-8编码
2. **路径**：使用 `os.path.join()` 拼接路径，确保跨平台兼容
3. **打包**：打包后设置文件保存在exe同级目录
4. **兼容性**：加载旧配置时需要处理字段默认值
